import{d as oe,u as le,r as h,n as L,o as f,c as p,a as o,t as C,b as P,F as I,e as ce,w as V,v as E,f as ie,g as re,T as de,h as b,i as U,j as O,_ as ue}from"./index-bb80a862.js";import{M as he,B as $,S as ve,C as D,a as T,b as ge,W as l,c as _e,A as w,d as fe,e as j,f as F,P as H,g as pe}from"./index-becf17fd.js";class ye{static toMessage(e){const t=new he;if(e.message_idstr?t.messageID=e.message_idstr:t.messageID=new $(e.message_id).toString(),e.header&&(t.header.reddot=e.header.red_dot===1),e.setting&&(t.setting=ve.fromUint8(e.setting)),e.revoke&&(t.remoteExtra.revoke=e.revoke===1),e.message_extra){const v=e.message_extra;t.remoteExtra=this.toMessageExtra(v)}t.clientSeq=e.client_seq,t.channel=new D(e.channel_id,e.channel_type),t.messageSeq=e.message_seq,t.clientMsgNo=e.client_msg_no,t.fromUID=e.from_uid,t.timestamp=e.timestamp,t.status=T.Normal;const i=ge.Buffer.from(e.payload,"base64"),c=JSON.parse(i.toString("utf8"));let r=0;c&&(r=c.type);const d=l.shared().getMessageContent(r);return c&&d.decode(this.stringToUint8Array(JSON.stringify(c))),t.content=d,t.isDeleted=e.is_deleted===1,t}static toMessageExtra(e){const t=new _e;e.message_id_str?t.messageID=e.message_id_str:t.messageID=new $(e.message_id).toString(),t.messageSeq=e.message_seq,t.readed=e.readed===1,e.readed_at&&e.readed_at>0&&(t.readedAt=new Date(e.readed_at)),t.revoke=e.revoke===1,e.revoker&&(t.revoker=e.revoker),t.readedCount=e.readed_count||0,t.unreadCount=e.unread_count||0,t.extraVersion=e.extra_version||0,t.editedAt=e.edited_at||0;const i=e.content_edit;if(i){const c=i.type,r=l.shared().getMessageContent(c),d=this.stringToUint8Array(JSON.stringify(i));r.decode(d),t.contentEditData=d,t.contentEdit=r,t.isEdit=!0}return t}static stringToUint8Array(e){const t=unescape(encodeURIComponent(e));for(var i=[],c=0,r=t.length;c<r;++c)i.push(t.charCodeAt(c));var d=new Uint8Array(i);return d}}const Ce={class:"chat"},ke={class:"header"},me={class:"center"},Se={class:"right"},we=["id"],be={key:0,class:"status"},De={class:"bubble right"},Te={class:"text"},qe={class:"avatar"},Ie=["id"],Ue={class:"avatar"},Ne={class:"bubble"},xe={class:"text"},Ae={class:"footer"},Me={class:"switch"},Be={class:"item"},Re=["onClick","checked"],Le={class:"item"},Pe=["onClick","checked"],Ve=["placeholder"],Ee=oe({__name:"Chat",setup(J){const e=le(),t=h(null),i=h(!1),c=h(""),r=h("");h();const d=h(""),v=h(!0),u=h(new D("",0)),k=h("请输入对方登录名"),y=h(!1),q=h(!1),_=h(new Array),m=e.currentRoute.value.query.uid||void 0,N=e.currentRoute.value.query.token||"token111";c.value=`${m||""}(未连接)`,(!w.shared.config.apiURL||w.shared.config.apiURL==="")&&(l.shared().connectManager.disconnect(),e.push({path:"/"})),w.shared.get("/route",{param:{uid:e.currentRoute.value.query.uid}}).then(s=>{console.log(s);let a=s.wss_addr;(!a||a==="")&&(a=s.ws_addr),K(a)}).catch(s=>{console.log(s),alert(s.msg)});const K=s=>{const a=l.shared().config;m&&N&&(a.uid=m,a.token=N),a.addr=s,l.shared().config=a,l.shared().config.provider.syncMessagesCallback=async(n,g)=>{let S=new Array;const se=30,B=await w.shared.post("/channel/messagesync",{login_uid:l.shared().config.uid,channel_id:n.channelID,channel_type:n.channelType,start_message_seq:g.startMessageSeq,end_message_seq:g.endMessageSeq,pull_mode:g.pullMode,limit:se}),R=B&&B.messages;return R&&R.forEach(ne=>{const ae=ye.toMessage(ne);S.push(ae)}),S},l.shared().connectManager.addConnectStatusListener(n=>{n==fe.Connected?c.value=`${m||""}(连接成功)`:c.value=`${m||""}(断开)`}),l.shared().chatManager.addMessageListener(n=>{_.value.push(n),x()}),l.shared().chatManager.addMessageStatusListener(n=>{console.log(n),_.value.forEach(g=>{if(g.clientSeq==n.clientSeq){g.status=n.reasonCode==1?T.Normal:T.Fail;return}})}),l.shared().connect()},G=()=>{if(!(!r.value||r.value.trim()===""))if(u.value&&u.value.channelID!=""){let s=new F(r.value);l.shared().chatManager.send(s,u.value),r.value=""}else i.value=!0},W=s=>{v.value=s.target.checked,v.value?k.value="请输入对方登录名":k.value="请输入群组ID"},z=s=>{v.value=!s.target.checked,v.value?k.value="请输入对方登录名":k.value="请输入群组ID"},x=()=>{const s=t.value;s&&L(function(){s.scrollTop=s.scrollHeight})},Q=async()=>{y.value=!0;const s=await l.shared().chatManager.syncMessages(u.value,{limit:15,startMessageSeq:0,endMessageSeq:0,pullMode:H.Up});y.value=!1,s&&s.length>0&&s.forEach(a=>{_.value.push(a)}),x()},X=async()=>{if(_.value.length==0)return;const s=_.value[0];if(s.messageSeq==1){q.value=!0;return}const a=15,n=await l.shared().chatManager.syncMessages(u.value,{limit:a,startMessageSeq:s.messageSeq-1,endMessageSeq:0,pullMode:H.Down});n.length<a&&(q.value=!0),n&&n.length>0&&n.reverse().forEach(g=>{_.value.unshift(g)}),L(function(){const g=t.value,S=document.getElementById(s.clientMsgNo);S&&(g.scrollTop=S.offsetTop)})},A=()=>{i.value=!i.value},Y=()=>{v.value?u.value=new D(d.value,pe):u.value=new D(d.value,j),v.value||Z(),i.value=!1,_.value=[],Q()},Z=()=>{w.shared.post("/channel/subscriber_add",{channel_id:u.value.channelID,channel_type:u.value.channelType,subscribers:[l.shared().config.uid]}).then(s=>{console.log(s)}).catch(s=>{console.log(s),alert(s.msg)})},ee=()=>{l.shared().connectManager.disconnect(),e.push({path:"/"})},M=s=>s.content instanceof F?s.content.text:"未知消息",te=s=>{const a=s.target.scrollTop;if(s.target.scrollHeight-(a+s.target.clientHeight),a<=250){if(y.value||q.value)return;y.value=!0,X().then(()=>{y.value=!1}).catch(()=>{y.value=!1})}};return(s,a)=>(f(),p(I,null,[o("div",Ce,[o("div",ke,[o("div",{class:"left"},[o("button",{onClick:ee},"退出")]),o("div",me,C(c.value),1),o("div",Se,[o("button",{onClick:A},C(u.value.channelID.length==0?"与谁会话？":`${u.value.channelType==P(j)?"群":"单聊"}${u.value.channelID}`),1)])]),o("div",{class:"content",onScroll:te,ref_key:"chatRef",ref:t},[(f(!0),p(I,null,ce(_.value,n=>(f(),p(I,null,[n.send?(f(),p("div",{key:0,class:"message right",id:n.clientMsgNo},[n.status!=P(T).Normal?(f(),p("div",be,"发送中")):b("",!0),o("div",De,[o("div",Te,C(M(n)),1)]),o("div",qe,C(n.fromUID.substring(0,1).toUpperCase()),1)],8,we)):b("",!0),n.send?b("",!0):(f(),p("div",{key:1,class:"message",id:n.clientMsgNo},[o("div",Ue,C(n.fromUID.substring(0,1).toUpperCase()),1),o("div",Ne,[o("div",xe,C(M(n)),1)])],8,Ie))],64))),256))],544),o("div",Ae,[V(o("input",{placeholder:"发送消息","onUpdate:modelValue":a[0]||(a[0]=n=>r.value=n),style:{height:"40px"}},null,512),[[E,r.value]]),o("button",{onClick:G},"发送")])]),ie(de,{name:"fade"},{default:re(()=>[i.value?(f(),p("div",{key:0,class:"setting",onClick:A},[o("div",{class:"setting-content",onClick:a[2]||(a[2]=U(()=>{},["stop"]))},[o("div",Me,[o("div",Be,[o("input",{type:"radio",onClick:U(W,["stop"]),checked:v.value},null,8,Re),O("单聊 ")]),o("div",Le,[o("input",{type:"radio",onClick:U(z,["stop"]),checked:!v.value},null,8,Pe),O("群聊 ")])]),V(o("input",{placeholder:k.value,class:"to","onUpdate:modelValue":a[1]||(a[1]=n=>d.value=n)},null,8,Ve),[[E,d.value]]),o("button",{class:"ok",onClick:Y},"确定")])])):b("",!0)]),_:1})],64))}});const je=ue(Ee,[["__scopeId","data-v-3b97de25"]]);export{je as default};
